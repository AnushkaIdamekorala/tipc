language: c++

addons:
  apt:
    packages: lcov

jobs:
  include:
    - os: linux
      dist: bionic
    - os: osx
      osx_image: xcode11

install:
  - bash bootstrap

script:
  - . ~/.bashrc
  - mkdir build
  - cd build
  - cmake ../
  - make
  - echo running unit tests...
  - ./test/unit/unit_tests
  - ./test/unit/types/types_test
  - echo running system tests...
  - cd ../test/system
  - ./run.sh

after_success:
  - lcov --capture --directory build/src -output-file coverage.info
  - lcov --remove /tmp/tipc.coverage.info '/usr/include/*' -o coverage.info
  - lcov --remove /tmp/tipc.coverage.info '*.h' -o coverage.info
  - lcov --remove /tmp/tipc.coverage.info '*.def' -o coverage.info
  - lcov --list coverage.info
  - export CODECOV_TOKEN="3799f38b-f5ba-49b3-9f51-ac1002ff5342"
  - bash <(curl -s https://codecov.io/bash) -f coverage.info || echo "Codecov did not collect coverage reports"
